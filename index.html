<!DOCTYPE html>
<html lang="en"> <!-- class="modal-is-open modal-is-opening modal-is-closing" -->
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>WOW & Flutter Machine Config Generator</title>
		<link rel="icon" type="image/png" href="/images/favicon/favicon-96x96.png" sizes="96x96" />
		<link rel="icon" type="image/svg+xml" href="/images/favicon/favicon.svg" />
		<link rel="shortcut icon" href="/images/favicon/favicon.ico" />
		<link rel="apple-touch-icon" sizes="180x180" href="/images/favicon/apple-touch-icon.png" />
		<meta name="apple-mobile-web-app-title" content="WOWConfig" />
		<link rel="manifest" href="/images/favicon/site.webmanifest" />
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.red.min.css">
		<link rel="stylesheet" href="/style.css">
		<script type="module">
			// import {createApp, reactive} from 'https://unpkg.com/petite-vue?module';
			import {createApp, reactive} from 'https://unpkg.com/petite-vue/dist/petite-vue.es.js';
			// import FFmpeg from 'https://unpkg.com/@ffmpeg/core/dist/esm/ffmpeg-core.js';
			// import {fetchFile, toBlobURL} from 'https://unpkg.com/@ffmpeg/util/dist/esm/index.js';
			import settings from './settings.json' with {type: 'json'};
			for (const value of Object.values(settings)) value.value = value.default;
			const store = reactive({
				settings,
				show: null,
				colour: 'chilli',
				looper: true,
				minimal: true,
			});
			function slider(name) {
				return {
					$template: '#slider',
					name,
					min: settings[name].values[0] || 0,
					max: settings[name].values[1] || 100,
					step: settings[name].values[2] || 1,
					label: settings[name].label,
					tooltip: settings[name].tooltip,
					prefix: settings[name].prefix || '',
					suffix: settings[name].suffix || '',
					invert: settings[name].invert || false,
				};
			}
			function select(name) {
				return {
					$template: '#select',
					name,
					values: settings[name].values,
					label: settings[name].label,
					tooltip: settings[name].tooltip,
				};
			}
			function boolean(name) {
				return {
					$template: '#switch',
					name,
					label: settings[name].label,
					tooltip: settings[name].tooltip,
				};
			}
			/* function dialog(section, title) {
				return {
					$template: '#dialog',
					section,
					title,
				};
			} */
			createApp({
				store,
				slider,
				select,
				boolean,
				// dialog,
				prefix: '[wowmachine]\n',
				colours: ['chilli', 'midnight', 'gold', 'silver'],
				themes: ['red', 'slate', 'amber', 'grey'],
				toggle(name) {
					this.store.show = this.store.show === name ? null : name;
					console.log(this.store.show);
				},
				nextColour() {
					this.store.colour = this.colours[this.colours.indexOf(this.store.colour) + 1] || this.colours[0];
				},
				updateTheme() {
					const link = document.querySelector('link[href^="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico"]');
					link.href = `https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.${this.themes[this.colours.indexOf(this.store.colour)]}.min.css`;
				},
				playWAV() {
					const audio = new Audio('/audio/fresh.wav');
					audio.play();
				},
				/* get sections() {
					return [...new Set(Object.values(this.store.settings).map(value => value.section))];
				},
				get sectioned() {
					return this.sections.map(section => this.store.settings.filter(value => value.section === section));
				}, */
				sectionSettings(section) {
					return Object.entries(this.store.settings).filter(([key, value]) => value.section === section).map(([key, {value}]) => `${key} = ${value}`).join('\n');
				},
				get config() {
					if (this.store.minimal) return this.prefix + Object.entries(this.store.settings).map(([key, {value}]) => `${key} = ${value}`).join('\n');
					return this.prefix + '\n#In this file, do not delete any #.\n\n' + Object.entries(this.store.settings).map(([key, value]) => `# ${value.comment}\n${key} = ${value.value}`).join('\n\n');
				},
				updateURL() {
					const url = new URL(window.location.href);
					url.searchParams.set('colour', this.store.colour);
					url.searchParams.set('looper', this.store.looper);
					url.searchParams.set('minimal', this.store.minimal);
					window.history.replaceState({}, '', url.toString());
				},
				download() {
					const blob = new Blob([this.config()], {type: 'text/plain'});
					const url = URL.createObjectURL(blob);
					const a = document.createElement('a');
					a.href = url;
					a.download = 'wow_settings.txt';
					a.click();
					URL.revokeObjectURL(url);
				},
				upload() {
					const fileInput = document.createElement('input');
					fileInput.type = 'file';
					fileInput.accept = '.txt';
					fileInput.onchange = (e) => {
						const file = e.target.files[0];
						const reader = new FileReader();
						reader.onload = (e) => {
							const config = e.target.result;
							const lines = config.split('\n');
							lines.forEach(line => {
								const [key, value] = line.split('=');
								if (key && value) {
									this.store.settings[key].value = value;
								}
							});
						}
						reader.readAsText(file);
					}
					fileInput.click();
				},
			}).mount(); // body // 'article#image'
		</script>
	</head>
	<body v-scope style="background-color: #101010;">
		<header style="text-align: center;">
			<h1 style="font-family: 'Montserrat', sans-serif; font-weight: 200; text-transform: uppercase; font-size: 3em;">
				<a href="https://headachesound.com" style="text-decoration: none; color: inherit;">
					<span style="letter-spacing: -0.3em;">Headache</span>
					<span style="letter-spacing: -0.2em;">Sound</span>
				</a>
				<a href="https://headachesound.com/wowspec" style="text-decoration: none; color: inherit; font-family: 'Lexend', sans-serif; font-size: 0.7em; padding-left: 0.5em;">
					Wow & Flutter Machine
				</a>
			</h1>
			<h2 style="font-family: 'Montserrat', sans-serif; font-weight: normal;">Config Generator</h2>
		</header>
		<main class="container">
			<p>Easily generate your <em>wow_settings.txt</em> config file with this handy tool</p>
			<article id="image" style="background-color: inherit;" v-effect="store.colour, updateTheme()">
				<form style="display: flex; gap: 2em; vertical-align: bottom;">
					<fieldset role="group">
						<legend>Customise your machine</legend>
						<article style="display: flex; gap: 2em;">
							<label>
								<input type="checkbox" v-model="store.looper" role="switch" />
								Looper
							</label>
							<label>Colour
								<select name="colour" id="colour" v-model="store.colour" style="max-width: 200px;">
									<option v-for="colour in colours" :value="colour">{{ colour }}</option>
								</select>
							</label>
						</article>
					</fieldset>
				</form>
				<div style="display: flex; justify-content: space-between; flex-wrap: wrap;">
					<div style="min-width: 50%; max-width: 800px;">
						<div style="position: relative;">
							<img :src="`/images/${store.colour}.jpg`" style="border-radius: 140px;" />
							<div id="platter" class="overlay circle" style="top: 6.5%; left: 9.8%; width: 81%; height: 81%;" @click="nextColour()" ></div>
							<div id="speaker" class="overlay circle" style="top: 2.5%; left: 2%; width: 20%; height: 20%;" @click="playWAV()"></div>
							<div id="effects" class="overlay highlight circle" style="top: 4%; left: 79.5%; width: 18%; height: 18%;" @click="toggle('effects')" :data-tooltip="sectionSettings('effects')" data-placement="bottom"></div>
							<div id="pitch" class="overlay highlight circle" style="top: 25%; left: 89%; width: 9%; height: 9%;" @click="toggle('pitch')" :data-tooltip="sectionSettings('pitch')" data-placement="left"></div>
							<div id="beat" class="overlay circle" style="top: 38.7%; left: 92.3%; width: 5%; height: 5%;" @click="toggle('beat')"></div>
							<div id="sample" class="overlay highlight circle" style="top: 47.1%; left: 92.3%; width: 5%; height: 5%;" @click="toggle('sample')" :data-tooltip="sectionSettings('sample')" data-placement="left"></div>
							<div id="fader" class="overlay highlight fader" style="top: 81%; left: 81%; width: 14%; height: 14%;" @click="toggle('fader')" :data-tooltip="sectionSettings('fader')" data-placement="top"></div>
							<img v-show="store.looper" src="/images/looper.jpg" style="position: absolute; top: 38%; left: 4%; height: 26%;" />
							<div v-show="store.looper" id="looper" class="overlay highlight pill" style="top: 37%; left: 3.3%; width: 5%; height: 28%;" @click="toggle('looper')" :data-tooltip="sectionSettings('looper')" data-placement="right"></div>
						</div>
					</div>
					<div style="width: 40%;">
						<form style="text-align: right;">
							<fieldset>
								<legend>Config File</legend>
								<button @click="upload" class="secondary"><span style="font-family: 'Material Icons Outlined';">upload</span> Upload Existing Config</button>
							</fieldset>
							<button @click="download"><span style="font-family: 'Material Icons Outlined';">download</span> Download Generated Config</button>
							<label>
								<input type="checkbox" role="switch" v-model="store.minimal" />
								Minimal Config File
							</label>
						</form>
						<pre style="padding: 1em; display: inline-block; overflow-x: scroll;">{{ config }}</pre>
					</div>
				</div>
			</article>
		</main>
		<footer style="text-align: center;">
			<p>Wow Machine Config App by <a href="https://mark.honeychurch.org">Mark Honeychurch</a></p>
		</footer>
		<dialog :open="store.show === 'effects'">
			<article>
				<header>
					<button aria-label="Close" @click="store.show = null" class="close"></button>
					<h3>Effects</h3>
				</header>
				<div v-scope="select('effect_mode')"></div>
				<article v-show="store.settings.effect_mode.value === 'delay' || store.settings.effect_mode.value === 'both'">
					<h3>Delay</h3>
					<div class="grid">
						<div v-scope="slider('delay_length')"></div>
						<div v-scope="slider('delay_strength')"></div>
					</div>
				</article>
				<article v-show="store.settings.effect_mode.value === 'reverb' || store.settings.effect_mode.value === 'both'">
					<h3>Reverb</h3>
					<div class="grid">
						<div v-scope="slider('reverb_roomsize')"></div>
						<div v-scope="slider('reverb_strength')"></div>
						<div v-scope="slider('reverb_damping')"></div>
						<div v-scope="slider('reverb_tone_low_pass_hz')"></div>
					</div>
				</article>
			</article>
		</dialog>
		<dialog :open="store.show === 'pitch'">
			<article>
				<header>
					<button aria-label="Close" @click="store.show = null" class="close"></button>
					<h3>Pitch</h3>
				</header>
				<div v-scope="slider('33rpm_value')"></div>
				<div class="grid">
					<div v-scope="slider('pitch_range_min')"></div>
					<div v-scope="slider('pitch_range_max')"></div>
				</div>
			</article>
		</dialog>
		<dialog :open="store.show === 'sample'">
			<article>
				<header>
					<button aria-label="Close" @click="store.show = null" class="close"></button>
					<h3>Sample</h3>
				</header>
				<div v-scope="slider('wheel_response')"></div>
				<div v-scope="slider('sample_high_pass_frequency')"></div>
			</article>
		</dialog>
		<dialog :open="store.show === 'fader'">
			<article>
				<header>
					<button aria-label="Close" @click="store.show = null" class="close"></button>
					<h3>Fader</h3>
				</header>
				<div v-scope="slider('fader_calibrate_lag')"></div>
				<div class="grid">
					<article>
						<h3>Left</h3>
						<div v-scope="select('fader_left')"></div>
						<div v-scope="slider('left_cut_value')"></div>
					</article>
					<article>
						<h3>Right</h3>
						<div v-scope="select('fader_right')"></div>
						<div v-scope="slider('right_cut_value')"></div>
					</article>
				</div>
			</article>
		</dialog>
		<dialog :open="store.show === 'looper'">
			<article>
				<header>
					<button aria-label="Close" @click="store.show = null" class="close"></button>
					<h3>Looper</h3>
				</header>
				<div v-scope="select('looper_mode')"></div>
			</article>
		</dialog>
		<template id="slider">
			<label>
				{{ label }}: <strong>{{ prefix }}{{ store.settings[name].value }}{{ suffix }}</strong>
				<input type="range" :name="name" :min="min" :max="max" :step="step" v-model="store.settings[name].value" :title="tooltip" :class="{invert}" />
			</label>
		</template>
		<template id="select">
			<label>
				{{ label }}
				<select :name="name" v-model="store.settings[name].value" :title="tooltip">
					<option v-for="value in values" :value="value">{{ value }}</option>
				</select>
			</label>
		</template>
		<template id="switch">
			<label>
				<input type="checkbox" role="switch" :name="name" v-model="store.settings[name].value" :title="tooltip" />
				{{ label }}
			</label>
		</template>
		<!--<template id="dialog">
			<dialog :open="store.show === section">
				<article>
					<header>
						<button aria-label="Close" @click="store.show = null"></button>
						<h3>{{ title }}</h3>
					</header>
					<fieldset>
						<slot></slot>
					</fieldset>
				</article>
			</dialog>
		</template>-->
	</body>
</html>

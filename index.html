<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>WOW & Flutter Machine Config Generator</title>
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.red.min.css"> <!-- amber, grey, slate -->
		<link rel="stylesheet" href="/style.css">
		<!-- <link rel="preconnect" href="https://fonts.googleapis.com">
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
		<link href="https://fonts.googleapis.com/css2?family=Lexend:wght@100..900&family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet"> -->
		<script type="module">
			import {createApp, reactive} from 'https://unpkg.com/petite-vue?module';
			// import {createApp, reactive} from 'https://unpkg.com/petite-vue/dist/petite-vue.es.js';
			import settings from './settings.json' with {type: 'json'};
			for (const value of Object.values(settings)) {
				value.value = value.default;
			}
			const store = reactive({settings, show: null});
			function slider(name) {
				return {
					$template: '#slider',
					name,
					min: settings[name].values[0] || 0,
					max: settings[name].values[1] || 100,
					step: settings[name].values[2] || 1,
					label: settings[name].label,
					tooltip: settings[name].tooltip,
				};
			}
			function select(name) {
				return {
					$template: '#select',
					name,
					values: settings[name].values,
					label: settings[name].label,
					tooltip: settings[name].tooltip,
				};
			}
			function boolean(name) {
				return {
					$template: '#switch',
					name,
					label: settings[name].label,
					tooltip: settings[name].tooltip,
				};
			}
			createApp({
				slider,
				select,
				boolean,
				store,
			}).mount('form#settings');
			createApp({
				// slider,
				// select,
				store,
				prefix: '[wowmachine]\n\n#In this file, do not delete any #.\n\n',
				colours: ['chilli', 'midnight', 'gold', 'silver'],
				themes: ['red', 'slate', 'amber', 'grey'],
				colour: 'chilli',
				looper: true,
				minimal: false,
				get config() {
					if (this.minimal) return '[wowmachine]\n' + Object.entries(this.store.settings).map(([key, value]) => `${key} = ${value.value}`).join('\n');
					return this.prefix + Object.entries(this.store.settings).map(([key, value]) => `# ${value.comment}\n${key} = ${value.value}`).join('\n\n');
				},
				changeColour(changed) {
					// If no colour is provided, increment the version, ensuring we don't go past the end of the array
					if (!changed) {
						this.colour = this.colours[this.colours.indexOf(this.colour) + 1] || this.colours[0];
					}
					const link = document.querySelector('link[href^="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico"]');
					link.href = `https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.${this.themes[this.colours.indexOf(this.colour)]}.min.css`;
				},
				nextColour() {
					this.colour = this.colours[this.colours.indexOf(this.colour) + 1] || this.colours[0];
				},
				updateTheme() {
					const link = document.querySelector('link[href^="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico"]');
					link.href = `https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.${this.themes[this.colours.indexOf(this.colour)]}.min.css`;
				},
				download() {
					const blob = new Blob([this.config()], {type: 'text/plain'});
					const url = URL.createObjectURL(blob);
					const a = document.createElement('a');
					a.href = url;
					a.download = 'wow_settings.txt';
					a.click();
					URL.revokeObjectURL(url);
				},
				toggle(name) {
					this.store.show = this.store.show === name ? null : name;
				},
				upload() {
					const fileInput = document.createElement('input');
					fileInput.type = 'file';
					fileInput.accept = '.txt';
					fileInput.onchange = (e) => {
						const file = e.target.files[0];
						const reader = new FileReader();
						reader.onload = (e) => {
							const config = e.target.result;
							const lines = config.split('\n');
							lines.forEach(line => {
								const [key, value] = line.split('=');
								if (key && value) {
									this.store.settings[key].value = value;
								}
							});
						}
						reader.readAsText(file);
					}
					fileInput.click();
				},
				getUploadedConfig(e) {
					const file = e.target.files[0];
					const reader = new FileReader();
					reader.onload = (e) => {
						const config = e.target.result;
						const lines = config.split('\n');
						lines.forEach(line => {
							const [key, value] = line.split('=');
							if (key && value) {
								this.store.settings[key].value = value;
							}
						});
					}
					reader.readAsText(file);
				},
			}).mount('article#image');
		</script>
		<template id="slider">
			<label>
				{{ label }}: {{ store.settings[name].value }}
				<input type="range" :name="name" :min="min" :max="max" :step="step" v-model="store.settings[name].value" :title="tooltip" />
			</label>
		</template>
		<template id="select">
			<label>
				{{ label }}
				<select :name="name" v-model="store.settings[name].value" :title="tooltip">
					<option v-for="value in values" :value="value">{{ value }}</option>
				</select>
			</label>
		</template>
		<template id="switch">
			<label>
				<input type="checkbox" role="switch" :name="name" v-model="store.settings[name].value" :title="tooltip" />
				{{ label }}
			</label>
		</template>
	</head>
	<body style="background-color: #101010;">
		<header style="text-align: center;">
			<h1 style="font-family: 'Montserrat', sans-serif; font-weight: 200; text-transform: uppercase; font-size: 3em;">
				<a href="https://headachesound.com" style="text-decoration: none; color: inherit;">
					<span style="letter-spacing: -0.3em;">Headache</span>
					<span style="letter-spacing: -0.2em;">Sound</span>
				</a>
				<a href="https://headachesound.com/wowspec" style="text-decoration: none; color: inherit; font-family: 'Lexend', sans-serif; font-size: 0.7em; padding-left: 0.5em;">
					Wow & Flutter Machine
				</a>
			</h1>
			<h2 style="font-family: 'Montserrat', sans-serif; font-weight: normal;">Config Generator</h2>
		</header>
		<main class="container">
			<p>Easily generate your <em>wow_settings.txt</em> config file with this handy tool</p>
			<article id="image" style="background-color: inherit;" v-effect="colour, updateTheme()">
				<form style="display: flex; gap: 2em; vertical-align: bottom;">
					<fieldset role="group">
						<legend>Customise your machine</legend>
						<article style="display: flex; gap: 2em;">
							<label>
								<input type="checkbox" v-model="looper" role="switch" />
								Looper
							</label>
							<label>Colour
								<select name="colour" id="colour" v-model="colour" style="max-width: 200px;">
									<option v-for="colour in colours" :value="colour">{{ colour }}</option>
								</select>
							</label>
						</article>
					</fieldset>
					<fieldset>
						<legend>Config File</legend>
						<!--input type="file" accept=".txt" @change="getUploadedConfig" /-->
						<button @click="upload" class="secondary"><span style="font-family: 'Material Icons Outlined';">upload</span> Upload Existing Config</button>
					</fieldset>
				</form>
				<div style="display: flex; justify-content: space-between; flex-wrap: wrap;">
					<div style="min-width: 50%; max-width: 800px;">
						<div style="position: relative;">
							<img :src="`/images/${colour}.jpg`" style="border-radius: 140px;" />
							<div id="platter" class="overlay circle" style="top: 6.5%; left: 9.8%; width: 81%; height: 81%;" @click="nextColour()" ></div>
							<div id="speaker" class="overlay circle" style="top: 2.5%; left: 2%; width: 20%; height: 20%;" @click="toggle('speaker')"></div>
							<div id="effect" class="overlay highlight circle" style="top: 4%; left: 79.5%; width: 18%; height: 18%;" @click="toggle('effect')"></div>
							<div id="pitch" class="overlay highlight circle" style="top: 25%; left: 89%; width: 9%; height: 9%;" @click="toggle('pitch')"></div>
							<div id="beat" class="overlay circle" style="top: 38.7%; left: 92.3%; width: 5%; height: 5%;" @click="toggle('beat')"></div>
							<div id="sample" class="overlay highlight circle" style="top: 47.1%; left: 92.3%; width: 5%; height: 5%;" @click="toggle('sample')"></div>
							<div id="fader" class="overlay highlight fader" style="top: 81%; left: 81%; width: 14%; height: 14%;" @click="toggle('fader')"></div>
							<img v-show="looper" src="/images/looper.jpg" style="position: absolute; top: 38%; left: 4%; height: 26%;" />
							<div v-show="looper" id="looper" class="overlay highlight pill" style="top: 37%; left: 3.3%; width: 5%; height: 28%;" @click="toggle('looper')"></div>
						</div>
					</div>
					<form id="settings" style="display: inline-block; min-width: 300px;">
						<fieldset v-show="store.show === 'fader'">
							<legend>Fader</legend>
							<article v-scope="slider('fader_calibrate_lag')"></article>
							<div class="grid">
								<article>
									<h3>Left</h3>
									<div v-scope="select('fader_left')"></div>
									<div v-scope="slider('left_cut_value')"></div>
								</article>
								<article>
									<h3>Right</h3>
									<div v-scope="select('fader_right')"></div>
									<div v-scope="slider('right_cut_value')"></div>
								</article>
							</div>
						</fieldset>
						<fieldset v-show="store.show === 'speaker'">
							<legend>Speaker</legend>
						</fieldset>
						<fieldset v-show="store.show === 'effect'">
							<legend>Effects</legend>
							<article v-scope="select('effect_mode')"></article>
							<article v-show="store.settings.effect_mode.value === 'delay' || store.settings.effect_mode.value === 'both'">
								<h3>Delay</h3>
								<div>
									<div v-scope="slider('delay_length')"></div>
									<div v-scope="slider('delay_strength')"></div>
								</div>
							</article>
							<article v-show="store.settings.effect_mode.value === 'reverb' || store.settings.effect_mode.value === 'both'">
								<h3>Reverb</h3>
								<div>
									<div v-scope="slider('reverb_roomsize')"></div>
									<div v-scope="slider('reverb_strength')"></div>
									<div v-scope="slider('reverb_damping')"></div>
									<div v-scope="slider('reverb_tone_low_pass_hz')"></div>
								</div>
							</article>
						</fieldset>
						<fieldset v-show="store.show === 'pitch'">
							<legend>Pitch</legend>
							<article>
								<div v-scope="slider('33rpm_value')"></div>
								<div v-scope="slider('pitch_range_min')"></div>
								<div v-scope="slider('pitch_range_max')"></div>
							</article>
						</fieldset>
						<fieldset v-show="store.show === 'beat'">
							<legend>Beat</legend>
							<div>
							</div>
						</fieldset>
						<fieldset v-show="store.show === 'sample'">
							<legend>Sample</legend>
							<article>
								<div v-scope="slider('wheel_response')"></div>
								<div v-scope="slider('sample_high_pass_frequency')"></div>
							</article>
						</fieldset>
						<fieldset v-show="store.show === 'looper'">
							<legend>Looper</legend>
							<article>
								<div v-scope="select('looper_mode')"></div>
							</article>
						</fieldset>
					</form>
				</div>
				<form style="text-align: right;">
					<button @click="download"><span style="font-family: 'Material Icons Outlined';">download</span> Download Generated Config</button>
					<label>
						<input type="checkbox" role="switch" v-model="minimal" />
						Minimal
					</label>
				</form>
				<pre style="padding: 1em;">{{ config }}</pre>
			</article>
		</main>
		<footer style="text-align: center;">
			<p>Wow Machine Config App by <a href="https://mark.honeychurch.org">Mark Honeychurch</a></p>
		</footer>
	</body>
</html>
